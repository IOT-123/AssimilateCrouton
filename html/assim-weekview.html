<link rel="import" href="../static/common/bower/polymer/polymer.html" />
<link rel="import" href="crouton-card.html" />
<link rel="import" href="../static/common/bower/paper-listbox/paper-listbox.html" />
<link rel="import" href="../static/common/bower/paper-item/paper-item.html" />
<dom-module id="assim-weekview">
    <template>
        <link rel="stylesheet" href="../css/assim-weekview.css" />
        <crouton-card color="{{endPointJson.color}}">
            <div class="dragger">
                <div class="listbox_header">MON</div>
                <div class="listbox_header">TUE</div>
                <div class="listbox_header">WED</div>
                <div class="listbox_header">THU</div>
                <div class="listbox_header">FRI</div>
                <div class="listbox_header">SAT</div>
                <div class="listbox_header">SUN</div>
            </div>
            <div class="expand">
                <div class="listbox_container">
                    <paper-listbox slot="dropdown-content" id="times_mon" multi selected-values="{{selectedValuesMon}}">
                        <template is="dom-repeat" items="[[itemsDay]]">
                            <paper-item>[[item.start]] - [[item.end]]</paper-item>
                        </template>
                    </paper-listbox>
                </div>
                <div class="listbox_container">
                    <paper-listbox slot="dropdown-content" id="times_mon" multi selected-values="{{selectedValuesTue}}">
                        <template is="dom-repeat" items="[[itemsDay]]">
                            <paper-item>[[item.start]] - [[item.end]]</paper-item>
                        </template>
                    </paper-listbox>
                </div>
                <div class="listbox_container">
                    <paper-listbox slot="dropdown-content" id="times_mon" multi selected-values="{{selectedValuesWed}}">
                        <template is="dom-repeat" items="[[itemsDay]]">
                            <paper-item>[[item.start]] - [[item.end]]</paper-item>
                        </template>
                    </paper-listbox>
                </div>
                <div class="listbox_container">
                    <paper-listbox slot="dropdown-content" id="times_mon" multi selected-values="{{selectedValuesThu}}">
                        <template is="dom-repeat" items="[[itemsDay]]">
                            <paper-item>[[item.start]] - [[item.end]]</paper-item>
                        </template>
                    </paper-listbox>
                </div>
                <div class="listbox_container">
                    <paper-listbox slot="dropdown-content" id="times_mon" multi selected-values="{{selectedValuesFri}}">
                        <template is="dom-repeat" items="[[itemsDay]]">
                            <paper-item>[[item.start]] - [[item.end]]</paper-item>
                        </template>
                    </paper-listbox>
                </div>
                <div class="listbox_container">
                    <paper-listbox slot="dropdown-content" id="times_mon" multi selected-values="{{selectedValuesSat}}">
                        <template is="dom-repeat" items="[[itemsDay]]">
                            <paper-item>[[item.start]] - [[item.end]]</paper-item>
                        </template>
                    </paper-listbox>
                </div>
                <div class="listbox_container">
                    <paper-listbox slot="dropdown-content" id="times_mon" multi selected-values="{{selectedValuesSun}}">
                        <template is="dom-repeat" items="[[itemsDay]]">
                            <paper-item>[[item.start]] - [[item.end]]</paper-item>
                        </template>
                    </paper-listbox>
                </div>
            </div>
            <div class="titleDisplay">{{endPointJson.title}}</div>
        </crouton-card>
    </template>
    <script>
        (function () {
            Polymer({
                is: "assim-weekview",
                properties: {
                    endPointJson: {
                        type: Object,
                        notify: true
                    },
                    itemsDay: {
                        notify: true,
                        type: Array
                    },
                    weekdayValues: {
                        type: Array,
                        value: [
                            "selectedValuesSun", 
                            "selectedValuesMon", 
                            "selectedValuesTue", 
                            "selectedValuesWed", 
                            "selectedValuesThu", 
                            "selectedValuesFri", 
                            "selectedValuesSat"
                        ]
                    },
                    selectedValuesMon: {
                        notify: true,
                        type: Array,
                        value: () => []
                    },
                    selectedValuesTue: {
                        notify: true,
                        type: Array,
                        value: () => []
                    },
                    selectedValuesWed: {
                        notify: true,
                        type: Array,
                        value: () => []
                    },
                    selectedValuesThu: {
                        notify: true,
                        type: Array,
                        value: () => []
                    },
                    selectedValuesFri: {
                        notify: true,
                        type: Array,
                        value: () => []
                    },
                    selectedValuesSat: {
                        notify: true,
                        type: Array,
                        value: () => []
                    },
                    selectedValuesSun: {
                        notify: true,
                        type: Array,
                        value: () => []
                    },
                    intervalHourIncrement: Number,
                    intervalHourDivisions: Number
                },
                observers: [
                    'newValues(endPointJson.values.*)'
                ],
                ready: function () {
                    this.setIntervals();
                    this.buildTimeArray('itemsDay');
                    this.startWatcherLoop();
                },
                attached: function () {

                },
                newValues: function (changeRecord) {//{"value": true}
                    var nowDeviceOn = this.endPointJson.values.value;  // device is off
                    // find thed current index 
                    // if not as sent change
                },
                setIntervals: function () {
                    var intervalMins = this.endPointJson.interval_mins;
                    var hoursDecimal = intervalMins / 60;
                    this.intervalHourIncrement = hoursDecimal < 1 ? 1 : Math.floor(hoursDecimal);
                    if (hoursDecimal >= 1) {
                        this.intervalHourDivisions = 1;
                    } else {
                        var intervalMod = intervalMins % 60;
                        var divs5min = intervalMod / 5;
                        this.intervalHourDivisions = 12 / divs5min;
                    }
                },
                buildTimeArray: function (timeArrayString) {
                    this[timeArrayString] = [];
                    var mins = 60 / this.intervalHourDivisions;
                    for (var i = 0; i < 24; i = i + this.intervalHourIncrement) {
                        for (var j = 0; j < this.intervalHourDivisions; j++) {
                            var startVal = this.pad(i, 2) + ":" + this.pad((j * mins), 2);
                            var endVal = "";
                            var endMins = ((j + 1) * mins);
                            if (endMins == 60) {
                                endVal = this.pad(i + this.intervalHourIncrement, 2) + ":00";
                            } else {
                                endVal = this.pad(i, 2) + ":" + this.pad(endMins, 2);
                            }
                            var item = { start: startVal, end: endVal };
                            this.push(timeArrayString, item);
                        }
                    }
                },
                startWatcherLoop: function () {
                    var p = this;
                    setInterval(function () {
                        var todaysSelectedStr = p.weekdayValues[new Date().getDay()];
                        var todaysSelectedTimes = p[todaysSelectedStr];
                        todaysSelectedTimes.forEach((i) => {
                            var startTime = p.setNewTodayTime(p.itemsDay[i].start);
                            var endTime = p.setNewTodayTime(p.itemsDay[i].end);
                            var nowTime = new Date();
                            if (startTime <= nowTime && nowTime <= endTime){
                                // get value from endpoint
                                // if true do nothing
                                // if false set endpoint value true (see button or toggle)

                            }
                       })
                    }, 5000); // every minute 60000
                },
                setNewTodayTime: function(timeStr){
                    var newParts = timeStr.split(":");
                    var newHrs = parseInt(newParts[0]);
                    var newMins = parseInt(newParts[1]);
                    var newTime = new Date();
                    newTime.setHours(newHrs);
                    newTime.setMinutes(newMins);
                    return newTime;
                },
                pad: function (n, width, z) {
                    z = z || '0';
                    n = n + '';
                    return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
                }
            });
        }());
    </script>
</dom-module>